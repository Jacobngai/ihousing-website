/**
 * Sitemap Index Generator for iHousing Multi-Language Deployment
 *
 * This script generates a sitemap index file that references
 * the 3 separate language-specific sitemaps.
 *
 * Usage: node scripts/generate-sitemap-index.js
 */

const fs = require('fs');
const path = require('path');

// Your 3 language deployments
const deployments = [
  {
    lang: 'en',
    siteUrl: 'https://www.inghengcredit.com',
    sitemapUrl: 'https://www.inghengcredit.com/sitemap.xml',
  },
  {
    lang: 'ms',
    siteUrl: 'https://www.kreditloan.my',
    sitemapUrl: 'https://www.kreditloan.my/sitemap.xml',
  },
  {
    lang: 'zh',
    siteUrl: 'https://www.inghengcredit.my',
    sitemapUrl: 'https://www.inghengcredit.my/sitemap.xml',
  },
];

/**
 * Generate sitemap index XML
 */
function generateSitemapIndex() {
  const today = new Date().toISOString().split('T')[0];

  const sitemapIndex = `<?xml version="1.0" encoding="UTF-8"?>
<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
               xmlns:xhtml="http://www.w3.org/1999/xhtml">
${deployments.map(dep => `  <sitemap>
    <loc>${dep.sitemapUrl}</loc>
    <lastmod>${today}</lastmod>
    <xhtml:link rel="alternate" hreflang="${dep.lang}" href="${dep.sitemapUrl}"/>
  </sitemap>`).join('\n')}
</sitemapindex>`;

  return sitemapIndex;
}

/**
 * Generate individual sitemap index for each deployment
 */
function generateDeploymentSitemapIndex() {
  const today = new Date().toISOString().split('T')[0];

  deployments.forEach(dep => {
    // For each deployment, generate a sitemap index that splits content by type
    const sitemapIndex = `<?xml version="1.0" encoding="UTF-8"?>
<sitemapindex xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <!-- Main Pages -->
  <sitemap>
    <loc>${dep.siteUrl}/sitemap-pages.xml</loc>
    <lastmod>${today}</lastmod>
  </sitemap>

  <!-- Blog Posts -->
  <sitemap>
    <loc>${dep.siteUrl}/sitemap-blog.xml</loc>
    <lastmod>${today}</lastmod>
  </sitemap>

  <!-- Property Pages -->
  <sitemap>
    <loc>${dep.siteUrl}/sitemap-properties.xml</loc>
    <lastmod>${today}</lastmod>
  </sitemap>
</sitemapindex>`;

    const outputDir = path.join(__dirname, '..', 'dist', dep.lang);
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true });
    }

    fs.writeFileSync(
      path.join(outputDir, 'sitemap-index.xml'),
      sitemapIndex,
      'utf-8'
    );

    console.log(`‚úÖ Generated sitemap index for ${dep.lang}: ${outputDir}/sitemap-index.xml`);
  });
}

/**
 * Generate split sitemaps by content type
 */
function generateSplitSitemaps() {
  const today = new Date().toISOString().split('T')[0];

  deployments.forEach(dep => {
    // Read the main sitemap.xml generated by Astro
    const distDir = path.join(__dirname, '..', 'dist', dep.lang);
    const mainSitemapPath = path.join(distDir, 'sitemap.xml');

    if (!fs.existsSync(mainSitemapPath)) {
      console.log(`‚ö†Ô∏è  No sitemap found for ${dep.lang}, skipping...`);
      return;
    }

    const sitemapContent = fs.readFileSync(mainSitemapPath, 'utf-8');

    // Parse URLs from sitemap
    const urlMatches = sitemapContent.match(/<loc>(.*?)<\/loc>/g) || [];

    const pagesUrls = [];
    const blogUrls = [];
    const propertyUrls = [];

    urlMatches.forEach(match => {
      const url = match.replace(/<loc>|<\/loc>/g, '');

      if (url.includes('/blog/')) {
        blogUrls.push(url);
      } else if (url.includes('/parkland/') || url.includes('/properties/')) {
        propertyUrls.push(url);
      } else {
        pagesUrls.push(url);
      }
    });

    // Generate split sitemaps
    const generateSitemap = (urls, filename) => {
      if (urls.length === 0) return;

      const sitemap = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:xhtml="http://www.w3.org/1999/xhtml">
${urls.map(url => {
  // Extract lastmod from URL if it's a blog post
  const blogDateMatch = url.match(/\/blog\/(\d{4}-\d{2}-\d{2})-/);
  const lastmod = blogDateMatch ? blogDateMatch[1] : today;

  return `  <url>
    <loc>${url}</loc>
    <lastmod>${lastmod}</lastmod>
  </url>`;
}).join('\n')}
</urlset>`;

      fs.writeFileSync(path.join(distDir, filename), sitemap, 'utf-8');
      console.log(`‚úÖ Generated ${filename} for ${dep.lang} (${urls.length} URLs)`);
    };

    generateSitemap(pagesUrls, 'sitemap-pages.xml');
    generateSitemap(blogUrls, 'sitemap-blog.xml');
    generateSitemap(propertyUrls, 'sitemap-properties.xml');
  });
}

/**
 * Generate robots.txt with sitemap reference
 */
function generateRobotsTxt() {
  deployments.forEach(dep => {
    const robotsTxt = `# robots.txt for ${dep.siteUrl}

User-agent: *
Allow: /

# Sitemap
Sitemap: ${dep.sitemapUrl}

# Crawl-delay (optional, be nice to bots)
Crawl-delay: 1`;

    const distDir = path.join(__dirname, '..', 'dist', dep.lang);
    if (!fs.existsSync(distDir)) {
      fs.mkdirSync(distDir, { recursive: true });
    }

    fs.writeFileSync(
      path.join(distDir, 'robots.txt'),
      robotsTxt,
      'utf-8'
    );

    console.log(`‚úÖ Generated robots.txt for ${dep.lang}`);
  });
}

// Main execution
console.log('üöÄ Generating sitemap index files...\n');

// 1. Generate main sitemap index (for all 3 deployments)
const mainIndex = generateSitemapIndex();
fs.writeFileSync(
  path.join(__dirname, '..', 'dist', 'sitemap-index.xml'),
  mainIndex,
  'utf-8'
);
console.log('‚úÖ Generated main sitemap-index.xml\n');

// 2. Generate individual deployment sitemap indices
generateDeploymentSitemapIndex();
console.log('');

// 3. Generate split sitemaps by content type
generateSplitSitemaps();
console.log('');

// 4. Generate robots.txt files
generateRobotsTxt();

console.log('\n‚ú® Sitemap index generation complete!');
console.log('\nüìã Next steps:');
console.log('1. Deploy each language site to its respective Vercel project');
console.log('2. Submit each sitemap.xml to Google Search Console separately:');
console.log('   - EN: https://www.inghengcredit.com/sitemap.xml');
console.log('   - MS: https://www.kreditloan.my/sitemap.xml');
console.log('   - ZH: https://www.inghengcredit.my/sitemap.xml');
